<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visão geral - EducaData</title>

  <link rel="stylesheet" href="./css/dashboard.css">
  <link rel="stylesheet" href="./css/logado.css">
  <link rel="stylesheet" href="./css/modalFiltro.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
</head>

<body>

  <aside>
    <div class="logo"><img src="./assets/icons/escola.svg"></div>

    <h2>Bem-vindo!</h2>
    <nav>
      <ul>
        <li><a href="overview.html" title="Overview"><img src="./assets/icons/inicio.svg" alt=""> Início</a></li>
        <li><a href="dashboard.html" title="Dashboard"><img src="./assets/icons/dashboard.svg" alt="">Dashboard</a></li>
        <li><a href="metas.html" title="Metas"><img src="./assets/icons/metas.svg" alt="">Metas</a></li>
        <li><a href="professores.html" title="Professores"><img src="./assets/icons/professores.svg"
              alt="">Professores</a></li>
        <li><a href="perfilUsuario.html" title="Perfil"><img src="./assets/icons/perfil.svg" alt="">Perfil</a></li>
        <li><a href="index.html" title="Sair"><img src="./assets/icons/sair.svg" alt="">Sair</a></li>
      </ul>
    </nav>
  </aside>

  <main>
    <h2 style="font-size: 25px;">Dashboard - Visão geral</h2>

    <div id="filtros-container">

      <div class="filtro">
        <button onclick="modalFiltro()"><label for=""><i class=" bi-funnel-fill"></i>Filtros</label></button>
      </div>

    </div>

    <div id="kpis-container">
      <div class="kpi" id="kpi-maior-mediana">
      <h4>Maior mediana de notas</h4>
      <h2 id="kpi-maior-nome"></h2>
      <h1 id="kpi-maior-valor" style="color: green;"></h1>
    </div>
      <div class="kpi" id="kpi-menor-mediana">
        <h4>Menor mediana de notas</h4>
        <h2 id="kpi-menor-nome"></h2>
        <h1 id="kpi-menor-valor" style="color: red;"></h1>
      </div>
      <div class="kpi" id="kpi-maior-dif">
        <h4>Maior diferença entre escola e Brasil</h4>
        <h2 id="kpi-maior-dif-nome"></h2>
        <h1 id="kpi-maior-dif-valor"></h1>
      </div>
      <div class="kpi" id="kpi-menor-dif">
        <h4>Menor diferença entre escola e Brasil</h4>
        <h2 id="kpi-menor-dif-nome"></h2>
        <h1 id="kpi-menor-dif-valor"></h1>
      </div>
    </div>
 
    
    <div class="textos">
      <h1>Histograma de notas dos alunos</h1>
      <h1>Distribuição de % por área de conhecimento</h1>
    </div>
  
    <div id="graficos-container">
      <div class="grafico-wrapper">
         <canvas id="grafico1"></canvas>
      </div>
      <div class="grafico-wrapper">
         <canvas id="grafico2"></canvas>
      </div>
    </div>
    
  </main>
  <div id="modal_container_adicionar"></div>
  <div id="modal_container_adicionar_filtro"></div>
  <div class="modal-container" id="modalErro">
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

let graficoHistograma;
let graficoMedianas;

function obterFiltroAtivo() {
  const idUsuario = sessionStorage.ID_USUARIO;
  if (!idUsuario) return Promise.resolve(null);

  return fetch('/filtros/listar/' + idUsuario)
    .then(res => res.json())
    .then(dados => {
      const ativo = dados.find(f => f.emUso === 'sim');
      return ativo || null;
    })
    .catch(e => {
      console.error('Erro ao obter filtros:', e);
      return null;
    });
}

function carregarKPIs(idEscola) {
  fetch('/dashboard/kpis/' + idEscola)
    .then(res => {
      if (!res.ok) throw new Error('Resposta não OK: ' + res.status);
      return res.json();
    })
    .then(dados => {
      const nomes = {
        cn: "Ciências da Natureza",
        ch: "Ciências Humanas",
        lp: "Linguagens",
        mt: "Matemática",
        red: "Redação"
      };

      document.getElementById("kpi-maior-nome").innerText = nomes[dados.maiorMediana];
      document.getElementById("kpi-maior-valor").innerText = `${Number(dados.valorMaiorMediana).toFixed(2)} pontos`;

      document.getElementById("kpi-menor-nome").innerText = nomes[dados.menorMediana];
      document.getElementById("kpi-menor-valor").innerText = `${Number(dados.valorMenorMediana).toFixed(2)} pontos`;

      const md = dados.maiorDiferenca;
      const me = dados.menorDiferenca;

      if (md && md.materia) {
        document.getElementById("kpi-maior-dif-nome").innerText = nomes[md.materia] || md.materia;
        document.getElementById("kpi-maior-dif-valor").innerText = `${Math.abs(md.diff).toFixed(1)} pontos ${md.diff > 0 ? 'acima' : 'abaixo'} do Brasil`;
      }

      if (me && me.materia) {
        document.getElementById("kpi-menor-dif-nome").innerText = nomes[me.materia] || me.materia;
        document.getElementById("kpi-menor-dif-valor").innerText = `${Math.abs(me.diff).toFixed(1)} pontos ${me.diff > 0 ? 'acima' : 'abaixo'} do Brasil`;
      }
    })
    .catch(err => console.error("Erro carregar KPIs", err));
}

function carregarKPIsQuery(query) {
  fetch('/dashboard/kpisComFiltro' + query)
    .then(res => {
      if (!res.ok) throw new Error('Resposta não OK: ' + res.status);
      return res.json();
    })
    .then(dados => {
      const nomes = { cn: "Ciências da Natureza", ch: "Ciências Humanas", lp: "Linguagens", mt: "Matemática", red: "Redação" };

      document.getElementById("kpi-maior-nome").innerText = nomes[dados.maiorMediana];
      document.getElementById("kpi-maior-valor").innerText = `${Number(dados.valorMaiorMediana).toFixed(2)} pontos`;

      document.getElementById("kpi-menor-nome").innerText = nomes[dados.menorMediana];
      document.getElementById("kpi-menor-valor").innerText = `${Number(dados.valorMenorMediana).toFixed(2)} pontos`;

      const md = dados.maiorDiferenca;
      const me = dados.menorDiferenca;

      if (md && md.materia) document.getElementById("kpi-maior-dif-nome").innerText = nomes[md.materia] || md.materia;
      if (md) document.getElementById("kpi-maior-dif-valor").innerText = `${Math.abs(md.diff).toFixed(1)} pontos ${md.diff > 0 ? 'acima' : 'abaixo'} do Brasil`;

      if (me && me.materia) document.getElementById("kpi-menor-dif-nome").innerText = nomes[me.materia] || me.materia;
      if (me) document.getElementById("kpi-menor-dif-valor").innerText = `${Math.abs(me.diff).toFixed(1)} pontos ${me.diff > 0 ? 'acima' : 'abaixo'} do Brasil`;
    })
    .catch(e => console.error('Erro ao carregar KPIs com filtro:', e));
}

function carregarHistograma(idEscola) {
  fetch('/dashboard/histograma/' + idEscola)
    .then(res => res.json())
    .then(dados => {
      const grafico1 = document.getElementById("grafico1").getContext("2d");
      if (graficoHistograma) graficoHistograma.destroy();

      graficoHistograma = new Chart(grafico1, {
        type: 'bar',
        data: { labels: dados.bins, datasets: [{ label: 'Histograma de notas dos alunos', data: dados.values, borderWidth: 1 }] },
        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });
    })
    .catch(erro => console.error("Erro ao carregar histograma:", erro));
}

function carregarHistogramaQuery(query) {
  const idEscolaUsuario = sessionStorage.ID_INSTITUICAO_USUARIO;
  if (!idEscolaUsuario) {
    console.error('ID_INSTITUICAO_USUARIO não está disponível');
    return;
  }

  const separator = query ? '&' : '';
  const url = '/dashboard/histogramaComparativo?idEscolaUsuario=' + idEscolaUsuario + (query ? query : '');

  fetch(url)
    .then(res => res.json())
    .then(dados => {
      const grafico1 = document.getElementById("grafico1").getContext("2d");
      if (graficoHistograma) graficoHistograma.destroy();

      graficoHistograma = new Chart(grafico1, {
        type: 'bar',
        data: {
          labels: dados.bins,
          datasets: [
            { label: 'Filtro Ativo', data: dados.dataFiltro, borderWidth: 1 },
            { label: 'Sua Escola', data: dados.dataEscola, borderWidth: 1 }
          ]
        },
        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });
    })
    .catch(erro => console.error("Erro ao carregar histograma comparativo:", erro));
}

function carregarMedianas(idEscola) {
  fetch('/dashboard/medianas/' + idEscola)
    .then(res => res.json())
    .then(dados => {
      const grafico2 = document.getElementById("grafico2").getContext("2d");
      if (graficoMedianas) graficoMedianas.destroy();

      graficoMedianas = new Chart(grafico2, {
        type: 'pie',
        data: { labels: dados.labels, datasets: [{ label: 'Distribuição de % por área de conhecimento', data: dados.values, backgroundColor: ["#78a8d1", "#ffc107", "#dc3545", "#91c7a9", "#6f42c1"], borderWidth: 0 }] },
        options: { maintainAspectRatio: false }
      });
    })
    .catch(erro => console.error("Erro ao carregar medianas:", erro));
}

function carregarMedianasQuery(query) {
  fetch('/dashboard/medianasComFiltro' + query)
    .then(res => res.json())
    .then(dados => {
      const grafico2 = document.getElementById("grafico2").getContext("2d");
      if (graficoMedianas) graficoMedianas.destroy();

      graficoMedianas = new Chart(grafico2, {
        type: 'pie',
        data: { labels: dados.labels, datasets: [{ label: 'Distribuição de % por área de conhecimento', data: dados.values, backgroundColor: ["#78a8d1", "#ffc107", "#dc3545", "#91c7a9", "#6f42c1"], borderWidth: 1 }] },
        options: { maintainAspectRatio: false }
      });
    })
    .catch(erro => console.error("Erro ao carregar medianas com filtro:", erro));
}

function carregarDashboardComFiltro(idEscolaUsuario) {
  obterFiltroAtivo()
    .then(filtro => {
      const escolaUsuario = sessionStorage.ID_INSTITUICAO_USUARIO ? Number(sessionStorage.ID_INSTITUICAO_USUARIO) : idEscolaUsuario;

      if (filtro) {
        const qs = [];
        if (filtro.idMateria) qs.push(`materia_id=${filtro.idMateria}`);
        if (filtro.idTipoEscola) qs.push(`tipoEscola_id=${filtro.idTipoEscola}`);
        if (filtro.idEstado) qs.push(`UF_id=${filtro.idEstado}`);
        const query = qs.length ? '?' + qs.join('&') : '';

        carregarKPIsQuery(query);
        carregarHistogramaQuery(query);
        carregarMedianasQuery(query);
      } else {
        carregarKPIs(escolaUsuario);
        carregarHistograma(escolaUsuario);
        carregarMedianas(escolaUsuario);
      }
    });
}

carregarDashboardComFiltro();

function modalFiltro() {
  modal_container_adicionar.innerHTML = `
    <div class="modal-container show">
      <div class="modal-overlay" onclick="fecharModal()"></div>
      <div class="modal">
        <button class="close-btn" onclick="fecharModal()">✖</button>
        <div class="form_filtro">
          <div class="novoFiltro">
            <button class="btn add-btn" onclick="modalAddFiltro()">
              <img src="./assets/icons/add_prof.svg" alt=""> Novo Filtro
            </button>
          </div>
          <div id="lista-filtros">Carregando...</div>
        </div>
      </div>
    </div>`;

  listarFiltros();
}

function modalAddFiltro() {
  modal_container_adicionar_filtro.innerHTML = `
    <div class="modal-container show modal-add-filtro">
      <div class="modal-overlay" onclick="fecharModalAdd()"></div>
      <div class="modal modal-add">
        <button class="close-btn" onclick="fecharModalAdd()">✖</button>
        <h1 class="titulo-add-filtro">Criar um novo filtro</h1>
        <div class="form_add_filtro">
          <div class="informacoes_add_filtro">
            <div class="form-group-add">
              <label for="input_nomeFiltro">Nome do filtro:</label>
              <input type="text" id="input_nomeFiltro" placeholder="Ex: Filtro Matemática SP">
            </div>
            <div class="form-group-add">
              <label for="select_materia">Matéria:</label>
              <select id="select_materia"></select>
            </div>
            <div class="form-group-add">
              <label for="select_tipoEscola">Tipo de Escola:</label>
              <select id="select_tipoEscola"></select>
            </div>
            <div class="form-group-add">
              <label for="select_estado">Estado (UF):</label>
              <select id="select_estado"></select>
            </div>
          </div>
        </div>
        <div class="boxButtonAdd">
          <button class="btnSalvarAdd" onclick="criarFiltro()">Salvar Filtro</button>
        </div>
      </div>
    </div>`;

  listarMaterias();
  listarTiposEscola();
  listarEstados();
}

function fecharModal() { modal_container_adicionar.innerHTML = ''; }
function fecharModalAdd() { modal_container_adicionar_filtro.innerHTML = ''; }

function listarMaterias() {
  return fetch("/filtros/materias")
    .then(res => res.json())
    .then(dados => {
      const select = document.getElementById("select_materia");
      if (!select) return;
      select.innerHTML = "";
      dados.forEach(materia => {
        const option = document.createElement("option");
        option.value = materia.id;
        option.textContent = materia.nome;
        select.appendChild(option);
      });
    })
    .catch(erro => console.error("Erro ao listar matérias:", erro));
}

function listarEstados() {
  return fetch("/filtros/estados")
    .then(res => res.json())
    .then(dados => {
      const select = document.getElementById("select_estado");
      if (!select) return;
      select.innerHTML = "";
      dados.forEach(estado => {
        const option = document.createElement("option");
        option.value = estado.id;
        option.textContent = estado.uf;
        select.appendChild(option);
      });
    })
    .catch(erro => console.error("Erro ao listar estados:", erro));
}

function listarTiposEscola() {
  return fetch("/filtros/tiposEscola")
    .then(res => res.json())
    .then(dados => {
      const select = document.getElementById("select_tipoEscola");
      if (!select) return;
      select.innerHTML = "";
      dados.forEach(tipo => {
        const option = document.createElement("option");
        option.value = tipo.id;
        option.textContent = tipo.tipo;
        select.appendChild(option);
      });
    })
    .catch(erro => console.error("Erro ao listar tipos de escola:", erro));
}

function listarFiltros() {
  const idUsuario = sessionStorage.ID_USUARIO;
  const container = document.getElementById("lista-filtros");
  if (!container) return;
  container.innerHTML = "Carregando...";

  fetch('/filtros/listar/' + idUsuario)
    .then(res => res.json())
    .then(dados => {
      container.innerHTML = '';
      if (dados.length > 0) {
        dados.forEach(filtro => {
          const htmlFiltro = `
            <div class="filtro-card">
              <div class="filtro-header">
                <h2>${filtro.nome}</h2>
                <span class="status ${filtro.emUso === 'sim' ? 'ativo' : 'inativo'}">${filtro.emUso === 'sim' ? 'Em uso' : 'Inativo'}</span>
              </div>
              <div class="filtro-body">
                <p><strong>Matéria:</strong> ${filtro.materia}</p>
                <p><strong>Tipo Escola:</strong> ${filtro.tipoEscola}</p>
                <p><strong>Estado:</strong> ${filtro.estado}</p>
              </div>
              <div class="filtro-actions">
                <button class="btn usar" onclick="alterarStatus(${filtro.id})">Usar</button>
                <button class="btn editar" onclick="modalEditarFiltro(${filtro.id},'${filtro.nome}',${filtro.idMateria},${filtro.idTipoEscola},${filtro.idEstado})">Editar</button>
                <button class="btn excluir" onclick="excluirFiltro(${filtro.id})">Excluir</button>
              </div>
            </div>`;
          container.insertAdjacentHTML('beforeend', htmlFiltro);
        });
      } else {
        container.innerHTML = `
          <div class="semFiltros">
            <p>Nenhum filtro cadastrado até o momento.</p>
            <p>Use o botão <strong>+ Novo Filtro</strong> para adicionar um.</p>
          </div>`;
      }
    })
    .catch(erro => console.error("Erro ao listar filtros:", erro));
}

function excluirFiltro(id) {
  fetch("/filtros/deletarFiltro", {
    method: "DELETE",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ idFiltro: id, idUsuario: sessionStorage.ID_USUARIO })
  })
  .then(res => {
    if (!res.ok) throw new Error('Erro ao deletar');
    alert("Filtro deletado com sucesso!");
    window.location.reload();
  })
  .catch(erro => console.error("Erro ao deletar filtro:", erro));
}

function alterarStatus(idFiltro) {
  fetch('/filtros/atualizarStatus/' + idFiltro, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ idUsuario: sessionStorage.ID_USUARIO })
  })
  .then(res => {
    if (res.status === 200) location.reload();
    else console.error('Falha ao alterar status', res.status);
  })
  .catch(erro => console.error('#ERRO: ' + erro));
}

function criarFiltro() {
  const nomeFiltro = document.getElementById('input_nomeFiltro').value;
  const materia_id = document.getElementById('select_materia').value;
  const tipoEscola_id = document.getElementById('select_tipoEscola').value;
  const UF_id = document.getElementById('select_estado').value;

  if (!nomeFiltro || !materia_id || !tipoEscola_id || !UF_id) {
    alert('Todos os campos devem ser preenchidos!');
    return;
  }

  fetch("/filtros/inserirFiltro", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ nomeFiltro: nomeFiltro, materia_id: materia_id, tipoEscola_id: tipoEscola_id, UF_id: UF_id, usuario_id: sessionStorage.ID_USUARIO, emUso: "nao" })
  })
  .then(res => {
    if (res.status === 200) location.reload();
    else if (res.status === 400) alert('Erro: filtro inválido');
  })
  .catch(erro => console.error('#ERRO: ' + erro));
}

function modalEditarFiltro(id, nomeFiltro, materia_id, tipoEscola_id, UF_id) {
  modal_container_adicionar_filtro.innerHTML = `
    <div class="modal-container show modal-add-filtro">
      <div class="modal-overlay" onclick="fecharModalAdd()"></div>
      <div class="modal modal-add">
        <button class="close-btn" onclick="fecharModalAdd()">✖</button>
        <h1 class="titulo-add-filtro">Edite seu filtro</h1>
        <div class="form_add_filtro">
          <div class="informacoes_add_filtro">
            <div class="form-group-add">
              <label for="input_nomeFiltro">Nome do filtro:</label>
              <input type="text" id="input_nomeFiltro" value="${nomeFiltro}">
            </div>
            <div class="form-group-add">
              <label for="select_materia">Matéria:</label>
              <select id="select_materia"></select>
            </div>
            <div class="form-group-add">
              <label for="select_tipoEscola">Tipo de Escola:</label>
              <select id="select_tipoEscola"></select>
            </div>
            <div class="form-group-add">
              <label for="select_estado">Estado (UF):</label>
              <select id="select_estado"></select>
            </div>
          </div>
        </div>
        <div class="boxButtonAdd">
          <button class="btnSalvarAdd" onclick="editarFiltro(${id})">Editar Filtro</button>
        </div>
      </div>
    </div>`;

  listarMaterias().then(() => { const s = document.getElementById('select_materia'); if (s) s.value = materia_id; });
  listarTiposEscola().then(() => { const s = document.getElementById('select_tipoEscola'); if (s) s.value = tipoEscola_id; });
  listarEstados().then(() => { const s = document.getElementById('select_estado'); if (s) s.value = UF_id; });
}

function editarFiltro(id) {
  const nomeFiltro = document.getElementById('input_nomeFiltro').value;
  const materia_id = document.getElementById('select_materia').value;
  const tipoEscola_id = document.getElementById('select_tipoEscola').value;
  const UF_id = document.getElementById('select_estado').value;

  if (!nomeFiltro || !materia_id || !tipoEscola_id || !UF_id) {
    alert('Todos os campos devem ser preenchidos!');
    return;
  }

  fetch('/filtros/atualizarFiltro/' + id, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ nomeFiltro, materia_id, tipoEscola_id, UF_id, idUsuario: sessionStorage.ID_USUARIO })
  })
  .then(res => {
    if (res.status === 200) location.reload();
    else alert('Erro ao atualizar filtro.');
  })
  .catch(erro => console.error('#ERRO: ' + erro));
}
</script>