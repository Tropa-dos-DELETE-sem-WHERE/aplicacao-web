<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visão geral - EducaData</title>

  <link rel="stylesheet" href="./css/dashboard.css">
  <link rel="stylesheet" href="./css/logado.css">
  <link rel="stylesheet" href="./css/modalFiltro.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
</head>

<body>

  <aside>
    <div class="logo"><img src="./assets/icons/escola.svg"></div>

    <h2>Bem-vindo, fulano!</h2>
    <nav>
      <ul>
        <li><a href="overview.html" title="Overview"><img src="./assets/icons/inicio.svg" alt=""> Início</a></li>
        <li><a href="dashboard.html" title="Dashboard"><img src="./assets/icons/dashboard.svg" alt="">Dashboard</a></li>
        <li><a href="metas.html" title="Metas"><img src="./assets/icons/metas.svg" alt="">Metas</a></li>
        <li><a href="professores.html" title="Professores"><img src="./assets/icons/professores.svg"
              alt="">Professores</a></li>
        <li><a href="perfilUsuario.html" title="Perfil"><img src="./assets/icons/perfil.svg" alt="">Perfil</a></li>
        <li><a href="index.html" title="Sair"><img src="./assets/icons/sair.svg" alt="">Sair</a></li>
      </ul>
    </nav>
  </aside>

  <main>
    <h1>Dashboard</h1>

    <div id="filtros-container">

      <div class="filtro">
        <button onclick="modalFiltro()"><label for=""><i class="bi bi-funnel-fill"></i>Filtros</label></button>
      </div>

    </div>

    <div id="kpis-container">
      <div class="kpi" id="kpi-maior-mediana">
      <h1>Maior mediana de notas</h1>
      <h2 id="kpi-maior-nome"></h2>
      <h3 id="kpi-maior-valor"></h3>
    </div>
      <div class="kpi" id="kpi-menor-mediana">
        <h1>Menor mediana de notas</h1>
        <h2 id="kpi-menor-nome"></h2>
        <h3 id="kpi-menor-valor"></h3>
      </div>
      <div class="kpi" id="kpi-maior-dif">
        <h1>Maior diferença entre escola e Brasil</h1>
        <h2 id="kpi-maior-dif-nome"></h2>
        <h3 id="kpi-maior-dif-valor"></h3>
      </div>
      <div class="kpi" id="kpi-menor-dif">
        <h1>Menor diferença entre escola e Brasil</h1>
        <h2 id="kpi-menor-dif-nome"></h2>
        <h3 id="kpi-menor-dif-valor"></h3>
      </div>
    </div>
 
    
    <div class="textos">
      <h1>Histograma de notas dos alunos</h1>
      <h1>Distribuição de % por área de conhecimento</h1>
    </div>
  
    <div id="graficos-container">
      <div class="grafico-wrapper">
         <canvas id="grafico1"></canvas>
      </div>
      <div class="grafico-wrapper">
         <canvas id="grafico2"></canvas>
      </div>
    </div>
    
  </main>
  <div id="modal_container_adicionar"></div>
  <div id="modal_container_adicionar_filtro"></div>
  <div class="modal-container" id="modalErro">
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>

async function carregarKPIs(idEscola) {
  // busca medianas da escola e do Brasil e popula os KPIs
  const resposta = await fetch('/dashboard/medianas/' + idEscola);
  const dados = await resposta.json();

  const materias = {
    "Ciências da Natureza": Number(dados.mediana_cn) || 0,
    "Ciências Humanas": Number(dados.mediana_ch) || 0,
    "Linguagens": Number(dados.mediana_lp) || 0,
    "Matemática": Number(dados.mediana_mt) || 0,
    "Redação": Number(dados.mediana_red) || 0
  };

  const maior = Object.entries(materias).reduce((a, b) => a[1] > b[1] ? a : b);
  const menor = Object.entries(materias).reduce((a, b) => a[1] < b[1] ? a : b);

  document.getElementById("kpi-maior-nome").innerText = maior[0];
  document.getElementById("kpi-maior-valor").innerText = `${maior[1]} pontos`;

  document.getElementById("kpi-menor-nome").innerText = menor[0];
  document.getElementById("kpi-menor-valor").innerText = `${menor[1]} pontos`;

  const respostaBrasil = await fetch(/dashboard/medianas-brasil);
  const brasil = await respostaBrasil.json();

  const diffs = {
    "Ciências da Natureza": (materias["Ciências da Natureza"] - (Number(brasil.mediana_cn) || 0)),
    "Ciências Humanas": (materias["Ciências Humanas"] - (Number(brasil.mediana_ch) || 0)),
    "Linguagens": (materias["Linguagens"] - (Number(brasil.mediana_lp) || 0)),
    "Matemática": (materias["Matemática"] - (Number(brasil.mediana_mt) || 0)),
    "Redação": (materias["Redação"] - (Number(brasil.mediana_red) || 0))
  };

  const maiorDif = Object.entries(diffs).reduce((a, b) => Math.abs(a[1]) > Math.abs(b[1]) ? a : b);
  const menorDif = Object.entries(diffs).reduce((a, b) => Math.abs(a[1]) < Math.abs(b[1]) ? a : b);

  document.getElementById("kpi-maior-dif-nome").innerText = maiorDif[0];
  document.getElementById("kpi-maior-dif-valor").innerText = `${Math.abs(maiorDif[1])} pontos ${maiorDif[1] > 0 ? 'acima' : 'abaixo'} do Brasil`;

  document.getElementById("kpi-menor-dif-nome").innerText = menorDif[0];
  document.getElementById("kpi-menor-dif-valor").innerText = `${Math.abs(menorDif[1])} pontos ${menorDif[1] > 0 ? 'acima' : 'abaixo'} do Brasil`;
}

// obter filtro ativo do usuário (emUso = 'sim')
async function obterFiltroAtivo() {
  const idUsuario = sessionStorage.ID_USUARIO;
  if (!idUsuario) return null;
  try {
    const res = await fetch('/filtros/listar/' + idUsuario);
    const dados = await res.json();
    const ativo = dados.find(f => f.emUso === 'sim');
    return ativo || null;
  } catch (e) {
    console.error('Erro ao obter filtros:', e);
    return null;
  }
}

async function carregarDashboardComFiltro() {
  const filtro = await obterFiltroAtivo();

  // determina a escola do usuário (sempre usada para KPIs)
  const escolaUsuario = sessionStorage.ID_INSTITUICAO_USUARIO ? Number(sessionStorage.ID_INSTITUICAO_USUARIO) : 12000094;
  // carregar KPIs sempre com as notas da escola do usuário
  carregarKPIs(escolaUsuario);

  if (filtro) {
    // usar endpoints com query params para histograma/medianas
    const qs = [];
    if (filtro.idMateria) qs.push(materia_id=filtro.idMateria);
    if (filtro.idTipoEscola) qs.push(tipoEscola_id=filtro.idTipoEscola);
    if (filtro.idEstado) qs.push(UF_id=filtro.idEstado);
    const query = qs.length ? '?' + qs.join('&') : '';

    carregarHistogramaQuery(query);
    carregarMedianas(escolaUsuario);
  } else {
    carregarHistograma(escolaUsuario);
    carregarMedianas(escolaUsuario);
  }
}

// wrappers that call the new endpoints with query string
function carregarHistogramaQuery(query) {
  // Build URL for comparativo endpoint
  const idEscolaUsuario = sessionStorage.ID_INSTITUICAO_USUARIO;
  if (!idEscolaUsuario) {
    console.error('ID_INSTITUICAO_USUARIO não está disponível');
    return;
  }


  // Monta query com id da escola
  let queryComparativo = idEscolaUsuario;
  
  // Se houver query params adicionais (materia_id, tipoEscola_id, UF_id), adiciona
  if (query) {
    const params = query.startsWith('?') ? query.substring(1) : query;
    queryComparativo += params ? '&' + params : '';
  }

  fetch('/dashboard/histogramaComparativo' + queryComparativo)
    .then(res => res.json())
    .then(dados => {
      const grafico1 = document.getElementById("grafico1").getContext("2d");
      if (graficoHistograma) graficoHistograma.destroy();
      graficoHistograma = new Chart(grafico1, {
        type: 'bar',
        data: { 
          labels: dados.bins, 
          datasets: [
            { 
              label: 'Filtro Ativo', 
              data: dados.dataFiltro, 
              backgroundColor: '#3498db',
              borderWidth: 1 
            },
            { 
              label: 'Sua Escola', 
              data: dados.dataEscola, 
              backgroundColor: '#e74c3c',
              borderWidth: 1 
            }
          ] 
        },
        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });
    })
    .catch(erro => console.error("Erro ao carregar histograma comparativo:", erro));
}


function carregarMedianasQuery(query) {
  fetch('/dashboard/medianas' + query)
    .then(res => res.json())
    .then(dados => {
      const grafico2 = document.getElementById("grafico2").getContext("2d");
      if (graficoMedianas) graficoMedianas.destroy();
      graficoMedianas = new Chart(grafico2, {
        type: 'pie',
        data: { labels: dados.labels, datasets: [{ label: 'Distribuição de % por área de conhecimento', data: dados.values, backgroundColor: ["#007bff","#ffc107","#dc3545","#28a745","#6f42c1"], borderColor: "#ffffff", borderWidth: 1 }] },
        options: { maintainAspectRatio: false }
      });
    })
    .catch(erro => console.error("Erro ao carregar medianas:", erro));
}

async function carregarKPIsQuery(query) {
  try {
    const resposta = await fetch('/dashboard/medianas' + query);
    const dados = await resposta.json();

    const materias = {
      "Ciências da Natureza": Number(dados.mediana_cn) || 0,
      "Ciências Humanas": Number(dados.mediana_ch) || 0,
      "Linguagens": Number(dados.mediana_lp) || 0,
      "Matemática": Number(dados.mediana_mt) || 0,
      "Redação": Number(dados.mediana_red) || 0
    };

    const maior = Object.entries(materias).reduce((a, b) => a[1] > b[1] ? a : b);
    const menor = Object.entries(materias).reduce((a, b) => a[1] < b[1] ? a : b);

    document.getElementById("kpi-maior-nome").innerText = maior[0];
    document.getElementById("kpi-maior-valor").innerText = `${maior[1]} pontos`;
    document.getElementById("kpi-menor-nome").innerText = menor[0];
    document.getElementById("kpi-menor-valor").innerText = `${menor[1]} pontos`;

    const respostaBrasil = await fetch(/dashboard/medianas-brasil);
    const brasil = await respostaBrasil.json();

    const diffs = {
      "Ciências da Natureza": (materias["Ciências da Natureza"] - (Number(brasil.mediana_cn) || 0)),
      "Ciências Humanas": (materias["Ciências Humanas"] - (Number(brasil.mediana_ch) || 0)),
      "Linguagens": (materias["Linguagens"] - (Number(brasil.mediana_lp) || 0)),
      "Matemática": (materias["Matemática"] - (Number(brasil.mediana_mt) || 0)),
      "Redação": (materias["Redação"] - (Number(brasil.mediana_red) || 0))
    };

    const maiorDif = Object.entries(diffs).reduce((a, b) => Math.abs(a[1]) > Math.abs(b[1]) ? a : b);
    const menorDif = Object.entries(diffs).reduce((a, b) => Math.abs(a[1]) < Math.abs(b[1]) ? a : b);

    document.getElementById("kpi-maior-dif-nome").innerText = maiorDif[0];
    document.getElementById("kpi-maior-dif-valor").innerText = `${Math.abs(maiorDif[1])} pontos ${maiorDif[1] > 0 ? 'acima' : 'abaixo'} do Brasil`;
    document.getElementById("kpi-menor-dif-nome").innerText = menorDif[0];
    document.getElementById("kpi-menor-dif-valor").innerText = `${Math.abs(menorDif[1])} pontos ${menorDif[1] > 0 ? 'acima' : 'abaixo'} do Brasil`;
  } catch (e) {
    console.error('Erro ao carregar KPIs com filtro:', e);
  }
}

//  const grafico1 = document.getElementById('grafico1');

  // new Chart(grafico1, {
  //   type: 'bar',
  //   data: {
  //     labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
  //     datasets: [{
  //       label: 'Histograma de notas dos alunos',
  //       data: [12, 19, 3, 5, 2, 3],
  //       borderWidth: 1
  //     }]
  //   },
  //   options: {
  //     maintainAspectRatio: false,
  //     scales: {
  //       y: {
  //         beginAtZero: true
  //       }
  //     }
  //   }
  // });

let graficoHistograma;

function carregarHistograma(idEscola) {
  fetch('/dashboard/histograma/' + idEscola)
    .then(resposta => resposta.json())
    .then(dados => {

      const grafico1 = document.getElementById("grafico1").getContext("2d");

      if (graficoHistograma) {
        graficoHistograma.destroy();
      }

      graficoHistograma = new Chart(grafico1, {
        type: 'bar',
        data: {
          labels: dados.bins,        
          datasets: [{
            label: 'Histograma de notas dos alunos',
            data: dados.values,     
            borderWidth: 1
          }]
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

    })
    .catch(erro => {
      console.error("Erro ao carregar histograma:", erro);
    });
}


  // const grafico2 = document.getElementById('grafico2');

  // new Chart(grafico2, {
  //   type: 'pie',
  //   data: {
  //     labels: ['Matemática', 'Linguagens', 'Ciencias Humanas', 'Ciencias da Natureza', 'Redação'],
  //     datasets: [{
  //       label: 'Distribuição de % por área de conhecimento',
  //       data: [12, 19, 3, 5, 2],
  //       borderWidth: 0.5,
  //     }]
  //   },
  //   options: {
  //     maintainAspectRatio: false,
  //     scales: {
  //       y: {
  //         beginAtZero: true
  //       }
  //     }
  //   }
  // });

let graficoMedianas; 

function carregarMedianas(idEscola) {
  fetch('/dashboard/medianas/' + idEscola)
    .then(resposta => resposta.json())
    .then(dados => {

      const grafico2 = document.getElementById("grafico2").getContext("2d");

      // destruir gráfico anterior caso exista
      if (graficoMedianas) {
        graficoMedianas.destroy();
      }

      graficoMedianas = new Chart(grafico2, {
        type: 'pie',
        data: {
          labels: dados.labels, 
          datasets: [{
            label: 'Distribuição de % por área de conhecimento',
            data: dados.values,  
            backgroundColor: [
              "#007bff", // Matemática
              "#ffc107", // Linguagens
              "#dc3545", // Humanas
              "#28a745", // Natureza
              "#6f42c1"  // Redação
            ],
            borderColor: "#ffffff",
            borderWidth: 1
          }]
        },
        options: {
          maintainAspectRatio: false
        }
      });

    })
    .catch(erro => {
      console.error("Erro ao carregar medianas:", erro);
    });
}

// chamar carregamento dos gráficos ao abrir a página
// carregar com base no filtro ativo (ou fallback)
carregarDashboardComFiltro();


function modalFiltro() {
  modal_container_adicionar.innerHTML = `
    <div class="modal-container show">
      <div class="modal-overlay" onclick="fecharModal()"></div>
      <div class="modal">
        <button class="close-btn" onclick="fecharModal()">✖</button>
        <div class="form_filtro">
          <div class="novoFiltro">
                 <button class="btn add-btn" onclick="modalAddFiltro()">
                  <img src="./assets/icons/add_prof.svg" alt=""> Novo Filtro
                </button>
           </div>
          <div id="lista-filtros"></div>
        </div>
      </div>
    </div>
  `;

  listarFiltros();
}
  function modalAddFiltro() {
    modal_container_adicionar_filtro.innerHTML = `
    <div class="modal-container show modal-add-filtro">
      <div class="modal-overlay" onclick="fecharModalAdd()"></div>
      <div class="modal modal-add">
        <button class="close-btn" onclick="fecharModalAdd()">✖</button>
        <h1 class="titulo-add-filtro">Criar um novo filtro</h1>
        
        <div class="form_add_filtro">
          <div class="informacoes_add_filtro">
            <div class="form-group-add">
              <label for="input_nomeFiltro">Nome do filtro:</label>
              <input type="text" id="input_nomeFiltro" placeholder="Ex: Filtro Matemática SP">
            </div>

            <div class="form-group-add">
              <label for="select_materia">Matéria:</label>
              <select id="select_materia"></select>
            </div>

            <div class="form-group-add">
              <label for="select_tipoEscola">Tipo de Escola:</label>
              <select id="select_tipoEscola"></select>
            </div>

            <div class="form-group-add">
              <label for="select_estado">Estado (UF):</label>
              <select id="select_estado"></select>
            </div>
          </div>
        </div>

        <div class="boxButtonAdd">
          <button class="btnSalvarAdd" onclick="criarFiltro()">Salvar Filtro</button>
        </div>
      </div>
    </div>
  `;

  listarMaterias();
  listarTiposEscola();
  listarEstados();
  }

  function fecharModal() {
    modal_container_adicionar.innerHTML = ``;
  }
  function fecharModalAdd() {
    modal_container_adicionar_filtro.innerHTML = ``;
  }


  function listarMaterias() {
  return  fetch("/filtros/materias", {
    method: "GET",
    headers: { "Content-Type": "application/json" }
  })
  .then(resposta => resposta.json())
  .then(dados => {
    console.log("Materias recebidas:", dados);
    const select = document.getElementById("select_materia");
    select.innerHTML = ""; 
    dados.forEach(materia => {
      const option = document.createElement("option");
      option.value = materia.id;
      option.textContent = materia.nome;
      select.appendChild(option);
    });
  })
  .catch(erro => {
    console.error("Erro ao listar matérias:", erro);
  });
}

function listarEstados() {
  return  fetch("/filtros/estados", {
    method: "GET",
    headers: { "Content-Type": "application/json" }
  })
  .then(resposta => resposta.json())
  .then(dados => {
    console.log("Estados recebidos:", dados);
    const select = document.getElementById("select_estado");
    select.innerHTML = "";
    dados.forEach(estado => {
      const option = document.createElement("option");
      option.value = estado.id;
      option.textContent = estado.uf;
      select.appendChild(option);
    });
  })
  .catch(erro => {
    console.error("Erro ao listar estados:", erro);
  });
}

function listarTiposEscola() {
  return fetch("/filtros/tiposEscola", {
    method: "GET",
    headers: { "Content-Type": "application/json" }
  })
  .then(resposta => resposta.json())
  .then(dados => {
    console.log("Tipos de escola recebidos:", dados);
    const select = document.getElementById("select_tipoEscola");
    select.innerHTML = "";
    dados.forEach(tipo => {
      const option = document.createElement("option");
      option.value = tipo.id;
      option.textContent = tipo.tipo;
      select.appendChild(option);
    });
  })
  .catch(erro => {
    console.error("Erro ao listar tipos de escola:", erro);
  });
}
async function listarFiltros() {
  const idUsuario = sessionStorage.ID_USUARIO;
  const container = document.getElementById("lista-filtros");
  container.innerHTML = ""; 
    const resposta = await fetch('/filtros/listar/' + idUsuario, {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });
    const dados = await resposta.json();
    console.log("Filtros recebidos:", dados);
    if (dados.length > 0) {
      dados.forEach(filtro => {
        const htmlFiltro = `
      <div class="filtro-card">
        <div class="filtro-header">
          <h2>${filtro.nome}</h2>
          <span class="status ${filtro.emUso === 'sim' ? 'ativo' : 'inativo'}">
            ${filtro.emUso === 'sim' ? 'Em uso' : 'Inativo'}
          </span>
        </div>
        <div class="filtro-body">
          <p><strong>Matéria:</strong> ${filtro.materia}</p>
          <p><strong>Tipo Escola:</strong> ${filtro.tipoEscola}</p>
          <p><strong>Estado:</strong> ${filtro.estado}</p>
        </div>
        <div class="filtro-actions">
          <button class="btn usar" onclick="alterarStatus(${filtro.id})">Usar</button>
          <button class="btn editar" onclick="modalEditarFiltro(${filtro.id},'${filtro.nome}',${filtro.idMateria},${filtro.idTipoEscola},${filtro.idEstado})">Editar</button>
          <button class="btn excluir" onclick="excluirFiltro(${filtro.id})">Excluir</button>
        </div>
      </div>
    `
        container.insertAdjacentHTML("beforeend", htmlFiltro);
      });
    } else {
      const htmlVazio = `
        <div class="semFiltros">
          <p>Nenhum filtro cadastrado até o momento.</p>
          <p>Use o botão <strong>+ Novo Filtro</strong> para adicionar um.</p>
        </div>
      `;
      container.insertAdjacentHTML("beforeend", htmlVazio);
    }
}
function excluirFiltro(id)
{
    fetch("/filtros/deletarFiltro", {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify
      ({ 
        idFiltro: id,
        idUsuario : sessionStorage.ID_USUARIO
       })
    });
    alert("meta deletada com sucesso!");
    window.location.reload();
}

function alterarStatus(idFiltro) {
    const idUsuario = sessionStorage.ID_USUARIO;  
    fetch('/filtros/atualizarStatus/' + idFiltro, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      idUsuario : sessionStorage.ID_USUARIO
    }),
  })
    .then(function (resposta) {
      if (resposta.status === 200) {
          console.log(resposta);
          location.reload();
        }
    })
    .catch(function (erro) {
      console.error(`#ERRO: ${erro}`);
    });
  }

  function criarFiltro()
  {
    const nomeFiltro = input_nomeFiltro.value;
    const materia_id = select_materia.value;
    const tipoEscola_id = select_tipoEscola.value;
    const UF_id = select_estado.value;
    const idUsuario = sessionStorage.ID_USUARIO;

    fetch("/filtros/inserirFiltro", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            nomeFiltro: nomeFiltro,
            materia_id: materia_id,
            tipoEscola_id: tipoEscola_id,
            UF_id: UF_id,
            usuario_id: idUsuario,
            emUso: "nao"
        }),
    })
    .then(function (resposta) {
        console.log("resposta: ", resposta.status);
        if (resposta.status === 200) {
            console.log(resposta);
            location.reload();
        } else if (resposta.status === 400) {
            document.getElementById("overlayInterno").classList.add("show");
            document.getElementById("modalErro").classList.add("show");
        }
    })
    .catch(function (resposta) {
        console.log(`#ERRO: ${resposta.status}`);
    });
  }

function modalEditarFiltro(id, nomeFiltro, materia_id, tipoEscola_id, UF_id) {
  console.log(id, nomeFiltro, materia_id, tipoEscola_id, UF_id)
  modal_container_adicionar_filtro.innerHTML = `
    <div class="modal-container show modal-add-filtro">
      <div class="modal-overlay" onclick="fecharModalAdd()"></div>
      <div class="modal modal-add">
        <button class="close-btn" onclick="fecharModalAdd()">✖</button>
        <h1 class="titulo-add-filtro">Edite seu filtro</h1>
        
        <div class="form_add_filtro">
          <div class="informacoes_add_filtro">
            <div class="form-group-add">
              <label for="input_nomeFiltro">Nome do filtro:</label>
              <input type="text" id="input_nomeFiltro" value="${nomeFiltro}">
            </div>

            <div class="form-group-add">
              <label for="select_materia">Matéria:</label>
              <select id="select_materia"></select>
            </div>

            <div class="form-group-add">
              <label for="select_tipoEscola">Tipo de Escola:</label>
              <select id="select_tipoEscola"></select>
            </div>

            <div class="form-group-add">
              <label for="select_estado">Estado (UF):</label>
              <select id="select_estado"></select>
            </div>
          </div>
        </div>

        <div class="boxButtonAdd">
          <button class="btnSalvarAdd" onclick="editarFiltro(${id})">Editar Filtro</button>
        </div>
      </div>
    </div>
  `;

 listarMaterias().then(() => {
  document.getElementById("select_materia").value = materia_id;
});

listarTiposEscola().then(() => {
  document.getElementById("select_tipoEscola").value = tipoEscola_id;
});

listarEstados().then(() => {
  document.getElementById("select_estado").value = UF_id;
});

}

function editarFiltro(id) {
  const nomeFiltro = input_nomeFiltro.value;
  const materia_id = select_materia.value;
  const tipoEscola_id = select_tipoEscola.value;
  const UF_id = select_estado.value;
  const idUsuario = sessionStorage.ID_USUARIO;

  if (!nomeFiltro || !materia_id || !tipoEscola_id || !UF_id) {
    alert("Todos os campos devem ser preenchidos.");
    return;
  }

  fetch('/filtros/atualizarFiltro/'+ id , {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      nomeFiltro,
      materia_id,
      tipoEscola_id,
      UF_id,
      idUsuario
    }),
  })
    .then(resposta => {
      if (resposta.status === 200) {
        console.log("Filtro atualizado com sucesso!");
        location.reload();
      } else {
        alert("Erro ao atualizar filtro.");
      }
    })
    .catch(erro => console.error(`#ERRO: ${erro}`));
}
</script>